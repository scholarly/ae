---
title: "Predicting Stock Returns with Cluster-Then-Predict"
author: "Terrel Shumway"
date: "04/20/2015"
output: html_document
---

This presents the answers for questions in part two of assignment 6.

```{r}
baseurl = "https://courses.edx.org/c4x/MITx/15.071x_2/asset/"

getdata = function(local){
  if(!file.exists(local)){
    library(downloader)
    remote = paste0(baseurl,local)
    download(remote,local)
  }
  read.csv(local,stringsAsFactors=FALSE)
}

data = getdata("StocksCluster.csv")


```

## Exploring the Dataset
problem 1.1: `r nrow(data)`

problem 1.2: `r mean(data$PositiveDec)`

```{r,results='asis'}
knitr::kable(cor(data))
cc = sort(cor(data),decreasing=TRUE)[13]
```
problem 1.3: `r cc`

problem 1.4
```{r}
indep = setdiff(names(data),"PositiveDec")
barplot(colMeans(data[,indep]))
```


## Logistic Regression Model

```{r}
library(caTools)
set.seed(144)
spl = sample.split(data$PositiveDec,SplitRatio=0.7)
train = data[spl,]
test = data[!spl,]

accuracy = function(c){(c[1,1]+c[2,2])/sum(c)}


m1 = glm(PositiveDec ~ ., data=train,family="binomial")
summary(m1)
m1.pred = predict(m1,newdata=train,method="response")
m1.conf = table(train$PositiveDec,m1.pred>0.5)
m1.acc = accuracy(m1.conf)

```
problem 2.1: accuracy=`r m1.acc`

```{r}
m1.pred = predict(m1,newdata=test,method="response")
m1.conf = table(test$PositiveDec,m1.pred>0.5)
m1.acc = accuracy(m1.conf)

```
problem 2.2: accuracy=`r m1.acc`

```{r}

bl.conf = table(test$PositiveDec)
bl.acc = bl.conf[2]/nrow(test)

```
problem 2.3: accuracy=`r bl.acc`

## Cluster then Predict

```{r}
ltrain = train
ltest = test
ltrain$PositiveDec = NULL
ltest$PositiveDec = NULL

library(caret)
preproc = preProcess(ltrain)
ntrain = predict(preproc,ltrain)
ntest = predict(preproc,ltest)
```
problem 3.2: `r mean(ntrain$ReturnJan)` `r mean(ntest$ReturnJan)`


```{r}
set.seed(144)
kluster = kmeans(ntrain,3)
```
problem 3.4: `r which.max(kluster$size)`

problem 3.5:
```{r}
library(flexclust)
storage = "stockcluster.Rdata.xz"
if(file.exists(storage)){
  load(storage)  
}else{  
  km.kcca = as.kcca(kluster,ntrain)
  save(km.kcca,file=storage,compress="xz")
}

ctrain = predict(km.kcca)
ctest = predict(km.kcca,newdata=ntest)

table(ctest)
```



